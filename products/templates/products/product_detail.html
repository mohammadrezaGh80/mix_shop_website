{% extends "_base.html" %}

{% load i18n %}
{% load price_conversion_tags %}
{% load humanize %}
{% get_current_language as LANGUAGE_CODE %}
{% load jalali_tags %}


{% block page_title %}{% trans product.title %}{% endblock page_title %}

{% block page_content %}
    <div>
        <div class="container">
            <div class="row">
                {% for message in messages %}
                    <p class="alert alert-{{ message.tags }}">{{ message }}</p>
                {% endfor %}

                <div class="col-12 my-3">
                    <div class="d-flex">
                        <div style="width: 50%;" id="carouselExampleIndicators" class="carousel slide">
                            <div class="carousel-indicators">
                                {% for slider in product.images.all %}
                                    <button type="button" data-bs-target="#carouselExampleIndicators"
                                            data-bs-slide-to="{{ forloop.counter0 }}"
                                            class="bg-danger {% if forloop.first %}active{% endif %}"></button>
                                {% endfor %}
                            </div>
                            <div class="carousel-inner">
                                {% for slider in product.images.all %}
                                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                        <img src="{{ slider.image.url }}" class="d-block w-100 object-fit-cover">
                                    </div>
                                {% endfor %}
                            </div>
                            <button class="carousel-control-prev" type="button"
                                    data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                                <span class="bg-danger d-flex rounded-circle p-2">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                </span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button"
                                    data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                                <span class="bg-danger d-flex rounded-circle p-2">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                </span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                        <div class="px-3 py-5 fs-5 fw-bold d-flex flex-column flex-grow-1">
                            <span>{{ product.title }}</span>
                            {% if product.color.count %}
                                <div class="d-flex align-items-center mt-4">
                                    {% if product.color.count > 1 %}
                                        <span>{% trans "Colors:" %}</span>
                                    {% else %}
                                        <span>{% trans "Color:" %}</span>
                                    {% endif %}
                                    <ul class="d-flex align-items-center">
                                        {% for color in product.color.all %}
                                            <li class="ps-2">{% trans color.color_name %}</li>
                                            {% if not forloop.last %}{% trans "," %} {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            {% if product.size.count %}
                                <div class="d-flex align-items-center mt-4">
                                    {% if product.size.count > 1 %}
                                        <span>{% trans "Sizes:" %}</span>
                                    {% else %}
                                        <span>{% trans "Size:" %}</span>
                                    {% endif %}
                                    <ul class="d-flex align-items-center">
                                        {% for size in product.size.all %}
                                            <li class="ps-2">{% trans size.size_name %}</li>
                                            {% if not forloop.last %}{% trans "," %} {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            <span class="fs-4 d-flex justify-content-end fw-bold mt-auto">
                                {% if LANGUAGE_CODE == "en" %}
                                    {% trans "$" %}{{ product.price|convert_price_to_dollar|intword }}
                                {% elif LANGUAGE_CODE == "fa" %}
                                    {{ product.price|convert_english_number_to_persian|intcomma:False }}
                                    {% trans "$" %}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="mw-100 my-5">{{ product.description|safe }}</div>
                    <div style="max-height: 450px" class="comment-section d-flex my-4">
                        {% if not user.is_authenticated %}
                            <a style="width: 160px; height: 50px"
                               href="{% url 'accounts:login' %}?next={% url 'products:product_detail' product.category product.pk %}"
                               class="btn btn-outline-danger align-self-end">
                                {% trans "Register comment" %}
                            </a>
                        {% else %}
                            <button style="width: 160px; height: 50px" type="button"
                                    class="btn btn-outline-danger align-self-end"
                                    data-bs-toggle="modal"
                                    data-bs-target="#registerComment">
                                {% trans "Register comment" %}
                            </button>

                            <div class="modal fade" id="registerComment">
                                <div style="max-width: 650px" class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header mx-3 px-0">
                                            <div>
                                                <span class="fs-5 fw-bold">{% trans "Your Comment" %}</span>
                                                <p style="font-size: 14px;" class="my-2">
                                                    {% blocktrans with title=product.title %}About
                                                        {{ title }}{% endblocktrans %}</p>
                                            </div>
                                            <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="card px-4 py-3">
                                                <form action="" method="post" class="comment-form">
                                                    {% csrf_token %}
                                                    <div class="d-flex flex-column mb-3">
                                                        <div class="d-flex align-items-center">
                                                            <span>{{ form.star_rating.label }}:</span>
                                                            <div class="d-flex flex-row-reverse align-items-center column-gap-1 wrapper-rating ms-3">
                                                                <input type="radio" id="id_star_rating_4"
                                                                       name="star_rating"
                                                                       value="5"
                                                                       class="opacity-0"
                                                                       {% if form.star_rating.value == 5 %}checked{% endif %}>
                                                                <label for="id_star_rating_4">
                                                                    <i class="bi bi-star"></i>
                                                                </label>
                                                                <input type="radio" id="id_star_rating_3"
                                                                       name="star_rating"
                                                                       value="4"
                                                                       class="opacity-0"
                                                                       {% if form.star_rating.value == 4 %}checked{% endif %}>
                                                                <label for="id_star_rating_3">
                                                                    <i class="bi bi-star"></i>
                                                                </label>
                                                                <input type="radio" id="id_star_rating_2"
                                                                       name="star_rating"
                                                                       value="3"
                                                                       class="opacity-0"
                                                                       {% if form.star_rating.value == 3 %}checked{% endif %}>
                                                                <label for="id_star_rating_2">
                                                                    <i class="bi bi-star"></i>
                                                                </label>
                                                                <input type="radio" id="id_star_rating_1"
                                                                       name="star_rating"
                                                                       value="2"
                                                                       class="opacity-0"
                                                                       {% if form.star_rating.value == 2 %}checked{% endif %}>
                                                                <label for="id_star_rating_1">
                                                                    <i class="bi bi-star"></i>
                                                                </label>
                                                                <input type="radio" id="id_star_rating_0"
                                                                       name="star_rating"
                                                                       value="1"
                                                                       class="opacity-0" required
                                                                       {% if form.star_rating.value == 1 %}checked{% endif %}>
                                                                <label for="id_star_rating_0">
                                                                    <i class="bi bi-star"></i>
                                                                </label>
                                                            </div>
                                                        </div>
                                                        {% for error in form.star_rating.errors %}
                                                            <p class="alert alert-danger mt-2 mb-0">{{ error }}</p>
                                                        {% endfor %}
                                                    </div>
                                                    <div class="d-flex flex-column mb-3">
                                                        <label class="form-label"
                                                               for="id_title">{{ form.title.label }}:</label>
                                                        {{ form.title }}
                                                        {% for error in form.title.errors %}
                                                            <p class="alert alert-danger mt-2 mb-0">{{ error }}</p>
                                                        {% endfor %}
                                                    </div>
                                                    <div class="d-flex flex-column mb-3">
                                                        <label class="form-label"
                                                               for="id_text">{{ form.text.label }}:</label>
                                                        {{ form.text }}
                                                        {% for error in form.text.errors %}
                                                            <p class="alert alert-danger mt-2 mb-0">{{ error }}</p>
                                                        {% endfor %}
                                                    </div>
                                                    <div class="d-flex mb-3">
                                                        {{ form.is_anonymous }}
                                                        <p class="ms-2">{% trans "Register a comment anonymously" %}</p>
                                                        {% for error in form.is_anonymous.errors %}
                                                            <p class="alert alert-danger mt-2 mb-0">{{ error }}</p>
                                                        {% endfor %}
                                                    </div>
                                                    <button type="submit"
                                                            class="btn btn-danger mt-3">{% trans "Register comment" %}</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        <div class="comments-wrapper flex-grow-1 mx-4 overflow-y-scroll">
                            <div class="text-end border-top border-2 pt-2">{{ comments.count }} {% trans "Comment" %}</div>
                            <div class="comments">
                                {% for comment in comments %}
                                    <div class="border-bottom border-2 py-4">
                                        <div class="d-flex">
                                        <span style="width: 30px;height: 25px"
                                              class="text-light px-1 rounded d-flex justify-content-center align-items-center me-2 {% if comment.star_rating >= 3 %}bg-success{% else %}bg-warning bg-gradient{% endif %}">
                                            {{ comment.star_rating }}
                                        </span>
                                            <div class="d-flex flex-column">
                                                {% if comment.title %}
                                                    <span class="fw-bold d-inline-block mb-2">{{ comment.title }}</span>
                                                {% endif %}
                                                <p class="mb-3">
                                                    {% if LANGUAGE_CODE == "fa" %}
                                                        <span>{{ comment.modified_datetime|to_jalali:"%Y/%m/%d %H:%M" }}</span>
                                                    {% elif LANGUAGE_CODE == "en" %}
                                                        <span>{{ comment.modified_datetime|date:"Y/m/d H:i" }}</span>
                                                    {% endif %}
                                                    <span>-</span>
                                                    {% if comment.is_anonymous %}
                                                        <span class="ms-1">{% trans "Digikala user" %}</span>
                                                    {% else %}
                                                        <span class="ms-1">{{ comment.user.email }}</span>
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </div>
                                        <p class="border-top border-bottom mx-4 py-3">{{ comment.text }}</p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock page_content %}
